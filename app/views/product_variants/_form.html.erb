<% additional_instructions ||= [] %>

<% content_for :css do %>
  <%= stylesheet_link_tag "entity_form" %>
<% end %>
<% content_for :js do %>
  <%= javascript_include_tag "entity_form", type: "module", crossorigin: true %>
<% end %>

<div class="Form Form--centered">
  <div class="Heading">
    <h1><%= yield :heading %></h1>
  </div>

  <details class="Instructions">
    <summary>Product Version / Update Guidelines</summary>
    <div class="Instructions-content Rte">
      <p>Thank you for contributing to HiFi&thinsp;Log!</p>
      <p>Please read the following instructions to make sure all products are added properly:</p>
      <ul>
        <li>If possible, please add a short, descriptive name like "LTD 2024" or "Update 2024".</li>
        <li>Not all information has to be filled out right away. Fields marked with "optional" can be filled out later.</li>
        <li>If you for example only know the year (or year and month) when an update / a version has been released or discontinued, you can omit the other fields.</li>
        <li>The description can contain any relevant information that is not covered by the other fields, i.e. more detailed information about this specific version or update as in "Temporarily available in special colors" or similar.</li>
        <li>
          The description field supports Markdown for basic styling:<br>
          <code><b><%= "**bold text**" %></b></code><br>
          <code><em><%= "*italic text*" %></em></code><br>
          <code><%= "- unordered lists" %></code><br>
          <code><%= "1. ordered lists" %></code>
        </li>
        <li>The price should ideally be the retail price recommended by the manufacturer provided in USD (or alternatively in EUR) to allow better comparisons. If you cannot provide that, you can also add the price in a different currency.</li>
        <li>Product versions / updates should cover smaller updates or special editions of a product, introduced under the same product name. Major updates (usually introduced with a name update like "MK II") or variants (usually coming with different technical performances) should be added as a new product.</li>
        <% additional_instructions.each do |instruction| %>
          <li><%= instruction %></li>
        <% end %>
      </ul>
      </ul>
    </div>
  </details>

  <% if @product_variant.errors.any? %>
    <%= render "shared/flash_messages", messages: @product_variant.errors.map { |error| ["alert", error.full_message] } %>
  <% end %>

  <div class="Form-field">
    <%= f.label :name, class: "Form-label" do %>
      <%= t('product.name') %> <small><i>(optional)</i></small>
    <% end %>
    <%= f.text_field :name %>
  </div>
  <div class="Form-field">
    <%= f.label :description, class: "Form-label" do %>
      <%= t('product.description') %> <small><i>(optional)</i></small>
    <% end %>
    <%= f.text_area :description %>
  </div>
  <div class="Form-field">
    <div class="u-flex u-gap-md">
      <div>
        <%= f.label :price, class: "Form-label" do %>
          <%= t('activerecord.attributes.product.price') %> <small><i>(optional)</i></small>
        <% end %>
        <%= f.text_field :price, inputmode: "number" %>
      </div>
      <div>
        <%= f.label :price_currency, class: "Form-label" do %>
          <%= t('activerecord.attributes.product.price_currency') %> <small><i>(optional)</i></small>
        <% end %>
        <%= f.select :price_currency do %>
          <option value=""></option>
          <% ['USD', 'EUR'].each do |id| %>
            <option value="<%= id %>"<%= " selected" if f.object[:price_currency] == id %>><%= CURRENCIES.find { |currency| currency[:id] == id }[:name] %></option>
          <% end %>
          <hr>
          <% CURRENCIES.select { |currency| !['USD', 'EUR'].include?(currency[:id]) }.sort_by { |currency| currency[:id] }.each do |currency| %>
            <option value="<%= currency[:id] %>"<%= " selected" if f.object[:price_currency] == currency[:id] %>><%= currency[:name] %></option>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>

  <div class="Form-field">
    <%= f.label :release_date, class: "Form-label" do %>
      <%= t('product.release_date') %> <small><i>(optional)</i></small>
    <% end %>
    <div class="EntityForm-date">
      <%= f.select :release_day, (1..31).map { |d| [d, d] }, { include_blank: "Day" }, { "aria-label": "Day" } %>
      <%= select_month(@product_variant.release_month, { field_name: "release_month", prefix: "product_variant", prompt: "Month" }, { "aria-label": "Month" }) %>
      <%= f.text_field :release_year, inputmode: "number", list: "years", placeholder: "Year", "aria-label": "Year" %>
    </div>
    <small>If you for example only know the year, you can also omit day and month.</small>
  </div>

  <% if @product.brand && @product.brand.discontinued %>
    <p class="EntityForm-note">
      <small>
        Since <i><%= @product.brand.name %></i> has been discontinued, this product will automatically be set to discontinued as well.
      </small>
    </p>
  <% else %>
    <div class="Form-field Form-field--inline Entity-discontinued">
      <span class="Form-label"><%= t('symbols.discontinued') %></span>
      <div class="Form-options">
        <%= f.radio_button :discontinued, 0, checked: (@product_variant.discontinued.nil? || @product_variant.discontinued == false) %>
        <%= f.label :discontinued, "No", value: 0 %>
        <%= f.radio_button :discontinued, 1, checked: (@product_variant.discontinued == true) %>
        <%= f.label :discontinued, "Yes", value: 1  %>
      </div>
    </div>

    <div class="Form-field Entity-discontinuedDate"<%= "hidden" unless @product_variant.discontinued? %>>
      <%= f.label :discontinued_date, class: "Form-label" do %>
        <%= t('product.discontinued_date') %> <small><i>(optional)</i></small>
      <% end %>
      <div class="EntityForm-date">
        <%= f.select :discontinued_day, (1..31).map { |d| [d, d] }, { include_blank: "Day" }, { "aria-label": "Day", disabled: @product_variant.discontinued.nil? || @product_variant.discontinued == false } %>
        <%= select_month(@product_variant.discontinued_month, { field_name: "discontinued_month", prefix: "product_variant", prompt: "Month" }, { "aria-label": "Month", disabled: (@product_variant.discontinued.nil? || @product_variant.discontinued == false) }) %>
        <%= f.text_field :discontinued_year, inputmode: "number", list: "years", placeholder: "Year", disabled: (@product_variant.discontinued.nil? || @product_variant.discontinued == false), "aria-label": "Year" %>
      </div>
      <small>If you for example only know the year, you can also omit day and month.</small>
      <datalist id="years">
        <% (1900..Date.today.year+1).to_a.reverse.each do |year| %>
          <option value="<%= year %>"></option>
        <% end %>
      </datalist>
    </div>
  <% end %>

  <% if include_comment %>
    <div class="Form-field Form-field--divider">
      <h2 class="h3 Form-label">
        <%= t('activerecord.attributes.version.comment') %> <small><i>(optional)</i></small>
      </h2>
      <%= f.text_area :comment %>
    </div>
  <% end %>

  <div class="Form-submit">
    <%= f.button type: "submit", class: "Button Button--loadingIcon" do %>
      <span><%= t('new_product.submit') %></span>
    <% end %>
  </div>
</div>
