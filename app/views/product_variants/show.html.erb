<% content_for :css do %>
  <%= stylesheet_link_tag "entity" %>
  <%= stylesheet_link_tag "product" %>
<% end %>
<div class="Entity">
  <div class="Entity-main">
    <div class="Product-details">
      <div class="Heading">
        <h1>
          <span><%= @product.brand.name %></span> <%= @product.name %>
          <small><%= @variant.name %></small>
        </h1>
      </div>

      <dl class="Data">
        <% if @variant.discontinued? %>
          <dt><%= t('status') %></dt>
          <dd><%= render "shared/symbols", product: @variant, show_labels: true, only: [:discontinued] %></dd>
        <% end %>
        <dt><%= t('headings.brand').html_safe %></dt>
        <dd><%= link_to @product.brand.name, brand_path(id: @product.brand.friendly_id) %></dd>
        <dt><%= t('headings.category').html_safe %></dt>
        <dd>
          <%= @product.sub_categories.map { |sub_category| link_to sub_category.name, products_path(sub_category: sub_category.friendly_id) }.join(", ").html_safe %>
          <% if @product.custom_attributes.present? %>
            <br><span class="Data-secondary"><%= custom_attributes_list @product %></span>
          <% end %>
        </dd>
        <dt><%= t('product.released') %></dt>
        <dd>
          <% if @variant.release_date.present? %>
            <time datetime="<%= @variant.release_date %>" data-format="false"><%= @variant.release_date %></time>
          <% else %>
            -
          <% end %>
        </dd>
        <% if @variant.discontinued? %>
          <dt><%= t('discontinued') %></dt>
          <dd>
            <% if @variant.discontinued_date.present? %>
              <time datetime="<%= @variant.discontinued_date %>" data-format="false"><%= @variant.discontinued_date %></time>
            <% else %>
              -
            <% end %>
          </dd>
        <% end %>
        <dt><%= t('activerecord.attributes.product.price') %><sup>1</sup></dt>
        <dd>
          <% if @variant.price.present? %>
            <%= @variant.display_price %>
          <% else %>
            -
          <% end %>
        </dd>
        <dt>Description</dt>
        <dd><%= @variant.description %></dd>
      </dl>

      <% if @product.description.present? %>
        <div class="Entity-description Rte">
          <%= sanitize @product.formatted_description.html_safe, tags: %w(p b i strong em br ul ol li) %>
        </div>
      <% end %>

      <% if @product.product_variants.any? %>
        <h2>Other versions / updates</h2>
        <table>
          <thead>
            <th><%= t('product.released') %></th>
            <th><%= t('product.name') %></th>
            <th><%= t('product.description') %></th>
            <th><%= t('activerecord.attributes.product.price') %><sup>1</sup></th>
          </thead>
          <tbody>
            <tr>
                <td><%= @product.release_date.present? ? @product.release_date : "-" %></td>
                <td><%= link_to @product.name, product_path(id: @product.friendly_id) %></td>
                <td>Initial / Stock version</td>
                <td><%= @product.price.present? ? @product.display_price : "-" %></td>
              </tr>
            <% @product.product_variants.order(:release_year, :release_month, :release_day).select { | variant | @variant != variant  }.each do |variant| %>
              <tr>
                <td><%= variant.release_date.present? ? variant.release_date : "-" %></td>
                <td><%= link_to variant.name, variant.path %></td>
                <td><%= variant.description.present? ? variant.description : "-" %></td>
                <td><%= variant.price.present? ? variant.display_price : "-" %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% end %>
    </div>
  </div>
  <div class="Entity-sub Product-sub u-pullOut">
    <%= render "products/actions", product: @product, variant: @variant %>

    <hr>

    <dl>
      <dt><%= t('product.meta.owned_by') %></dt>
      <dd><%= t('amount_users', count: @variant.users.size) %></dd>
    </dl>

    <div class="Entity-meta">
      <dl>
        <dt><%= t('headings.contributors') %></dt>
        <dd>
          <%= @contributors.any? ? @contributors.map { |c| c["profile_visibility"] != 0 ? (link_to c["user_name"], user_path(id: c["user_name"].downcase)) : c["user_name"] }.join(", ").html_safe : "hifilog.com" %>
          </ul>
        </dd>
      </dl>

      <ul class="Entity-metaLinks">
        <li>
          <%= link_to t('edit'), user_signed_in? ? product_edit_variant_path(product_id: @product.friendly_id, variant: @variant.friendly_id) : new_user_session_path(redirect: product_edit_variant_path(product_id: @product.friendly_id, variant: @variant.friendly_id)) %>
        </li>
        <li>
          <%= link_to t('headings.changelog'), user_signed_in? ? product_variant_changelog_path(product_id: @product.friendly_id, variant: @variant.friendly_id) : new_user_session_path(redirect: product_variant_changelog_path(product_id: @product.friendly_id, variant: @variant.friendly_id)) %>
        </li>
      </ul>
    </div>
  </div>
</div>

<ol class="Footnotes">
  <li>The provided price is the retail price given by the manufacturer. If the product has multiple variants, this is the lowest price, i.e. the price for the basic version. Please note that this information might be outdated and that it most likely is different from country to country.</li>
</ol>
