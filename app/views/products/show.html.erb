<% content_for :css do %>
  <%= stylesheet_link_tag "entity" %>
  <%= stylesheet_link_tag "product" %>
<% end %>
<div class="Entity">
  <div class="Entity-main">
    <div class="Product-details">
      <div class="Heading">
        <h1>
          <span><%= @product.brand.name %></span> <%= @product.name %>
        </h1>
      </div>

      <dl class="Data">
        <% if @product.discontinued %>
          <dt><%= t('status') %></dt>
          <dd><%= render "shared/symbols", product: @product, show_labels: true, only: [:discontinued] %></dd>
        <% end %>
        <dt><%= t('headings.brand').html_safe %></dt>
        <dd><%= link_to @product.brand.name, brand_path(id: @product.brand.friendly_id) %></dd>
        <dt><%= t('headings.category').html_safe %></dt>
        <dd>
          <%= @product.sub_categories.map { |sub_category| link_to sub_category.name, products_path(sub_category: sub_category.friendly_id) }.join(", ").html_safe %>
          <% if @product.custom_attributes.present? %>
            <br><span class="Data-secondary"><%= custom_attributes_list @product %></span>
          <% end %>
        </dd>
        <dt><%= t('product.released') %></dt>
        <dd>
          <% if @product.release_date.present? %>
            <time datetime="<%= @product.release_date %>" data-format="false"><%= @product.release_date %></time>
          <% else %>
            -
          <% end %>
        </dd>
        <% if @product.discontinued? %>
          <dt><%= t('discontinued') %></dt>
          <dd>
            <% if @product.discontinued_date.present? %>
              <time datetime="<%= @product.discontinued_date %>" data-format="false"><%= @product.discontinued_date %></time>
            <% else %>
              -
            <% end %>
          </dd>
        <% end %>
        <dt><%= t('activerecord.attributes.product.price') %><sup>1</sup></dt>
        <dd>
          <% if @product.price.present? %>
            <%= @product.display_price %>
          <% else %>
            -
          <% end %>
        </dd>
      </dl>

      <% if @product.description.present? %>
        <div class="Entity-description Rte">
          <%= sanitize @product.formatted_description.html_safe, tags: %w(p b i strong em br ul ol li) %>
        </div>
      <% end %>

      <% if @product.product_variants.any? %>
        <h2>Updates</h2>
        <table>
          <thead>
            <th><%= t('product.released') %></th>
            <th><%= t('product.name') %></th>
            <th><%= t('product.description') %></th>
            <th><%= t('activerecord.attributes.product.price') %></th>
          </thead>
          <tbody>
            <% @product.product_variants.order(:release_year, :release_month, :release_day).each do |variant| %>
              <tr>
                <td><%= variant.release_date.present? ? variant.release_date : "-" %></td>
                <td><%= variant.name.present? ? variant.name : "-" %></td>
                <td><%= variant.description.present? ? variant.description : "-" %></td>
                <td><%= variant.price.present? ? variant.display_price : "-" %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% end %>
    </div>
  </div>
  <div class="Entity-sub Product-sub u-pullOut">
    <% if user_has_product?(current_user, @product) %>
      <div class="Product-action">
        <%= button_to owned_product_path(id: @product.id), method: :delete, class: "Button Button--loadingIcon", "aria-pressed": "true" do %>
          <span>✓ <%= t('symbols.in_your_collection') %></span>
          <span><%= t('remove_from_collection').html_safe %></span>
        <% end %>
      </div>

      <% @setups.each do |setup| %>
        <div class="Product-action Product-action--setup">
          <% if setup.products.include?(@product) %>
            <%= button_to t('in_setup', name: setup.name).html_safe, setup_product_path(product_id: @product.id, setup_id: setup.id), method: :delete, class: "CheckboxButton is-checked" %>
          <% else %>
            <%= button_to t('in_setup', name: setup.name).html_safe, setup_products_path(product_id: @product.id, setup_id: setup.id), method: :post, class: "CheckboxButton" %>
          <% end %>
        </div>
      <% end %>
    <% else %>
      <div class="Product-action">
        <%= button_to owned_products_path(id: @product.id), class: "Button Button--loadingIcon", "aria-pressed": "false" do %>
          <span><%= t('add_to_collection').html_safe %></span>
        <% end %>
      </div>
    <% end %>

    <div class="Product-action">
      <% if @bookmark %>
        <%= button_to bookmark_path(id: @bookmark.id), method: :delete, class: "Button Button--loadingIcon", "aria-pressed": "true" do %>
          <span>✓ <%= t('symbols.in_your_bookmarks') %></span>
          <span><%= t('remove_from_bookmarks').html_safe %></span>
        <% end %>
      <% else %>
        <%= button_to bookmarks_path(id: @product.id), class: "Button Button--loadingIcon Button--secondary", "aria-pressed": "false" do %>
          <span><%= t('add_to_bookmarks').html_safe %></span>
        <% end %>
      <% end %>
    </div>

    <div class="Product-action">
      <% if @prev_owned %>
        <%= button_to prev_owned_path(id: @prev_owned.id), method: :delete, class: "CheckboxButton is-checked", "aria-pressed": "true" do %>
          <span><%= t('add_to_prev_owned') %></span>
        <% end %>
      <% else %>
        <%= button_to prev_owneds_path(id: @product.id), class: "CheckboxButton", "aria-pressed": "false" do %>
          <span><%= t('add_to_prev_owned') %></span>
        <% end %>
      <% end %>
    </div>

    <hr>

    <dl>
      <dt><%= t('product.meta.owned_by') %></dt>
      <dd><%= t('amount_users', count: @product.users.size) %></dd>
    </dl>

    <div class="Entity-meta">
      <dl>
        <dt><%= t('headings.contributors') %></dt>
        <dd>
          <%= @contributors.any? ? @contributors.map { |c| c["profile_visibility"] != 0 ? (link_to c["user_name"], user_path(id: c["user_name"].downcase)) : c["user_name"] }.join(", ").html_safe : "hifilog.com" %>
          </ul>
        </dd>
      </dl>

      <ul class="Entity-metaLinks">
        <li>
          <%= link_to t('edit'), user_signed_in? ? edit_product_path(id: @product.friendly_id) : new_user_session_path(redirect: edit_product_path(id: @product.friendly_id)) %>
        </li>
        <li>
          <%= link_to t('headings.changelog'), user_signed_in? ? product_changelog_path(product_id: @product.friendly_id) : new_user_session_path(redirect: product_changelog_path(product_id: @product.friendly_id)) %>
        </li>
      </ul>
    </div>
  </div>
</div>

<ol class="Footnotes">
  <li>The provided price is the retail price given by the manufacturer. If the product has multiple variants, this is the lowest price, i.e. the price for the basic version. Please note that this information might be outdated and that it most likely is different from country to country.</li>
</ol>
