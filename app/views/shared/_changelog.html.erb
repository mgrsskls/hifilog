<% content_for :css do %>
  <%= stylesheet_link_tag "changelog" %>
<% end %>

<h1><%= t('headings.changelog') %> <span><%= model.name %></span></h1>

<% if model.versions.any? %>
  <ol reversed class="Changelog">
    <% model.versions.reverse.each_with_index do |version, i| %>
      <%
        if version.whodunnit.nil?
          user_fallback = "hifilog.com"
        else
          if User.find_by(id: version.whodunnit).nil?
            user_fallback = "<i>Unknown</i>"
          else
            user = User.find(version.whodunnit)
          end
        end
      %>
      <li class="Changelog-item">
        <p>
            <b>
            <% if version.event == "create" %>
              <b>Created</b>
            <% else %>
              <%= t('changelog.change', number: model.versions.size - i - 1) %>
            <% end %>
            </b>
            <%= t('changelog.by') %>
            <% if user %>
              <%= user.profile_visibility === "hidden" ? user.user_name : link_to(user.user_name, user_path(user.user_name)) %>
            <% else %>
              <%= user_fallback.html_safe %>
            <% end %>
            &mdash;
            <time data-time="true" datetime="<%= formatted_datetime version.created_at %>"><%= formatted_datetime version.created_at %></time>
        </p>
        <table-saw>
          <table class="Changelog-data">
            <thead>
              <tr>
                <th><%= t('changelog.attribute') %></th>
                <th><%= t('changelog.before') %></th>
                <th><%= t('changelog.after') %></th>
              </tr>
            </thead>
            <tbody>
            <% changelog(version.object_changes).each do |change| %>
              <tr>
                <td><%= t('brand.' + change[0]) %></td>
                <td>
                  <span class="Changelog-old">
                   <% if change[0] == "brand_id" && change[1][0].present? %>
                      <%= Brand.find(change[1][0]).name %>
                    <% elsif change[0] == "country_code" && change[1][0].present? %>
                      <%= country_name(change[1][0]) %>
                    <% else %>
                      <% if change[1][0] == false %>
                        No
                      <% elsif change[1][0] == true %>
                        Yes
                      <% else %>
                        <%= change[1][0] %>
                      <% end %>
                    <% end %>
                  </span>
                </td>
                <td>
                  <span class="Changelog-new">
                    <% if change[0] == "brand_id" && change[1][1].present? %>
                      <%= Brand.find(change[1][1]).name %>
                    <% elsif change[0] == "country_code" && change[1][1].present? %>
                      <%= country_name(change[1][1]) %>
                    <% else %>
                      <% if change[1][1] == false %>
                        No
                      <% elsif change[1][1] == true %>
                        Yes
                      <% else %>
                        <%= change[1][1] %>
                      <% end %>
                    <% end %>
                  </span>
                </td>
              </tr>
            <% end %>
            </tbody>
          </table>
        </table-saw>
      </li>
    <% end %>
  </ol>
<% else %>
  <p>No changelog entries so far.</p>
<% end %>

<%= render "shared/back_link", path: back_path %>
