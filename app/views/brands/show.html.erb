<% content_for :css do %>
  <%= stylesheet_link_tag "entity", crossorigin: true, integrity: true %>
<% end %>

  <div class="Entity">
    <div class="Entity-main">
      <div class="Product-details">

        <div class="Entity-heading">
          <h1>
            <%= @brand.name %>
            <% if @brand.full_name %><span class="IndexPage-category"><%= @brand.full_name %></span><% end %>
          </h1>
        </div>

        <div class="Entity-section">
          <dl class="Data Entity-data">
            <% if @brand.discontinued %>
              <dt><%= t('status') %></dt>
              <dd><span class="Symbol"><%= t('symbols.discontinued') %></span></dd>
            <% end %>
            <dt><%= Brand.human_attribute_name(:country_code) %></dt>
            <dd>
              <div class="u-flex u-alignCenter u-gap-smd">
                <% if @brand.country_name.present? %>
                  <img class="Flag" src="/flags/<%= @brand.country_code.downcase %>.svg" alt="Flag of <%= @brand.country_name %>" title="<%= @brand.country_name %>" loading="lazy" width="25">
                  <%= @brand.country_name %>
                <% else %>
                  -
                <% end %>
              </div>
            </dd>
            <dt><%= Brand.human_attribute_name(:website) %></dt>
            <dd><%= @brand.website.present? ? (link_to @brand.website, "#{@brand.website}?utm_source=hifilog.com&utm_medium=referral", rel: "noreferrer noopener") : "-" %></dd>
            <dt><%= t('brand.founded') %></dt>
            <dd>
              <% if @brand.founded_date.present? %>
                <time datetime="<%= format_iso_date @brand.founded_date %>"><%= sanitize @brand.formatted_founded_date %></time>
              <% else %>
                -
              <% end %>
            </dd>
            <% if @brand.discontinued? %>
              <dt><%= t('discontinued') %></dt>
              <dd>
                <% if @brand.discontinued_date.present? %>
                  <time datetime="<%= format_iso_date @brand.discontinued_date %>"><%= sanitize @brand.formatted_discontinued_date %></time>
                <% else %>
                  -
                <% end %>
              </dd>
            <% end %>
          </dl>
          <% if @brand.formatted_description.present? %>
            <div class="Rte">
              <%= @brand.formatted_description %>
            </div>
          <% end %>
        </div>


        <div class="Entity-heading">
          <h2>
            <%= Product.model_name.human(count: 2) %>
          </h2>
          <a href="<%= brand_products_path(brand_id: @brand.friendly_id) %>"><b>Show all products</b></a>
        </div>


        <% if @all_sub_categories_grouped.any? %>
          <dl class="Data">
            <% @all_sub_categories_grouped.each do |section| %>
              <dt><%= section[0].name %></dt>
              <dd><%= section[1].map { |c| link_to c.name, brand_products_path(@brand, category:  "#{section[0].slug}[#{c.slug}]") }.join(", ").html_safe %></dd>
            <% end %>
          </dl>
        <% else %>
          <div class="EmptyState">
            <p><b>No categories or products have been added to <i><%= @brand.name %></i> yet.</b></p>
            <p>You can <a href="<%= edit_brand_path(id: @brand.friendly_id) %>">edit information</a> about <i><%= @brand.name %></i> or <a href="<%= new_product_path(brand_id: @brand.id) %>">add products</a>.</p>
          </div>
        <% end %>
      </div>
    </div>

    <div class="Entity-sub">
      <% if user_has_brand?(current_user, @brand, false) %>
        <div class="EntityPossession u-textCenter" data-current="true">
          You own <b><%= @brand.name %></b> products.
        </div>
        <hr>
      <% elsif user_has_brand?(current_user, @brand, true) %>
        <div class="EntityPossession u-textCenter" data-current="false">
          You used to own <b><%= @brand.name %></b> products.
        </div>
        <hr>
      <% end %>
      <dl>
        <dt><%= t('product.meta.owned_by') %></dt>
        <dd><%= t('amount_users', count: User.joins(:products).where(products: { brand_id: @brand.id }).distinct.size) %></dd>
      </dl>

      <div class="Entity-meta">
        <dl>
          <dt><%= t('headings.contributors') %></dt>
          <dd>
            <%= @contributors.any? ? @contributors.map { |c| c["profile_visibility"] != 0 ? (link_to c["user_name"], user_path(id: c["user_name"].downcase)) : c["user_name"] }.join(", ").html_safe : "hifilog.com" %>
            </ul>
          </dd>
        </dl>

        <hr>

        <ul class="Entity-metaLinks MetaLinks">
          <li>
            <%= link_to t('edit'), user_signed_in? ? edit_brand_path(id: @brand.friendly_id) : new_user_session_path(redirect: edit_brand_path(id: @brand.friendly_id)) %>
          </li>
          <li>
            <%= link_to t('headings.changelog'), user_signed_in? ? brand_changelog_path(@brand) : new_user_session_path(redirect: brand_changelog_path(@brand)) %>
          </li>
        </ul>
      </div>
    </div>
  </div>
