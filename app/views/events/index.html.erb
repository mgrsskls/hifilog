<% content_for :css do %>
  <%= stylesheet_link_tag "events", crossorigin: true, integrity: true %>
<% end %>

<div class="Events">
  <div class="Heading">
    <h1>Hi-Fi Events</h1>

    <form class="u-flex u-gap-md u-alignCenter">
      <label for="events-filter">Countries</label>
      <%= country_select(nil,
        "country",
        {
        only: @country_codes,
          include_blank: "All",
          selected: params[:country]&.upcase
        },
        {
          id: "events-filter"
        })
      %>
    </form>
  </div>

  <% filtered_country_name = country_name_from_country_code(params[:country]) if params[:country].present? %>
  <p class="u-textCenter">
    <small><%= filtered_country_name.present? ? "#{@events.count} upcoming events in #{filtered_country_name}" : "#{@events.count} upcoming events worldwide." %></small>
  </p>

  <% i = 1 %>
  <% if @years.any? %>
    <div class="Events-years">
      <% @years.each do |year| %>
        <div class="Events-year">
          <h2><%= year[0] %></h2>
          <div class="Events-months">
          <% year[1].each do |month| %>
            <div class="Events-month">
              <h3><%= Date::MONTHNAMES[month[0]] %></h3>
              <ol class="Events-list" start="<%= i %>">
                <% month[1].each do |event| %>
                  <% i += 1 %>
                  <li class="Event">
                    <div class="Event-header">
                      <span class="Event-days">
                        <time datetime="<%= event.start_date %>">
                          <%= event.start_date.strftime("%A") %> <%= event.start_date.strftime("%-d").to_i.ordinalize %>
                        </time>
                        <% if event.end_date.present? %> â€“
                          <time datetime="<%= event.end_date %>">
                            <%= event.end_date.strftime("%A") %> <%= event.end_date.strftime("%-d").to_i.ordinalize %>
                          </time>
                        <% end %>
                      </span>
                      <div class="u-flex u-alignCenter u-gap-md">
                        <% country_name = country_name_from_country_code(event.country_code) %>
                        <img class="Flag" src="/flags/<%= event.country_code.downcase %>.svg" alt="Flag of <%= country_name %>" title="<%= country_name %>" loading="lazy" width="25">
                      </div>
                    </div>
                    <h4>
                      <%= event.name %>
                    </h4>
                    <address>
                      <p>
                        <%= event.address.gsub("\n", "<br>").html_safe %><br>
                        <%= country_name %>
                      </p>
                    </address>
                    <% if event.url.present? %>
                      <a href="<%= event.url %>"><%= event.url %></a>
                    <% end %>
                  </li>
                <% end %>
              </ol>
            </div>
          <% end %>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <%= render "shared/empty_state", message: "<p>There are no upcoming events.</p>" %>
  <% end %>
</div>
